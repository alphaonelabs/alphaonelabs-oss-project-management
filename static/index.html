<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSS Project Management</title>
  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0d1117;
  color: #c9d1d9;
  line-height: 1.6;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

header {
  background: #161b22;
  border-bottom: 1px solid #30363d;
  padding: 16px 0;
  margin-bottom: 24px;
}

header h1 {
  font-size: 24px;
  font-weight: 600;
  color: #58a6ff;
}

.auth-section {
  text-align: center;
  padding: 60px 20px;
}

.auth-section h2 {
  margin-bottom: 16px;
  font-size: 32px;
}

.auth-section p {
  color: #8b949e;
  margin-bottom: 24px;
}

.btn {
  display: inline-block;
  padding: 8px 16px;
  background: #238636;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  text-decoration: none;
  transition: background 0.2s;
}

.btn:hover {
  background: #2ea043;
}

.btn-secondary {
  background: #21262d;
  border: 1px solid #30363d;
}

.btn-secondary:hover {
  background: #30363d;
}

.btn-small {
  padding: 4px 12px;
  font-size: 12px;
}

.controls {
  background: #161b22;
  padding: 16px;
  border-radius: 6px;
  margin-bottom: 16px;
  display: grid;
  gap: 12px;
}

.control-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.control-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

input[type="text"], select {
  background: #0d1117;
  border: 1px solid #30363d;
  color: #c9d1d9;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
}

input[type="text"] {
  min-width: 300px;
}

label {
  font-size: 14px;
  font-weight: 500;
  color: #8b949e;
}

.bulk-actions {
  display: none;
  gap: 8px;
  padding: 12px;
  background: #21262d;
  border-radius: 6px;
  margin-bottom: 16px;
}

.bulk-actions.active {
  display: flex;
}

table {
  width: 100%;
  background: #161b22;
  border-radius: 6px;
  overflow: hidden;
  border-collapse: collapse;
}

th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #21262d;
}

th {
  background: #0d1117;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  color: #8b949e;
  cursor: pointer;
  user-select: none;
}

th:hover {
  background: #161b22;
}

th.sortable::after {
  content: ' â‡…';
  opacity: 0.3;
}

th.sorted-asc::after {
  content: ' â†‘';
  opacity: 1;
}

th.sorted-desc::after {
  content: ' â†“';
  opacity: 1;
}

tr:hover {
  background: #0d1117;
}

.issue-number {
  color: #8b949e;
  text-decoration: none;
}

.issue-number:hover {
  color: #58a6ff;
}

.issue-title {
  color: #c9d1d9;
  font-weight: 500;
}

.state-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.state-open {
  background: #238636;
  color: white;
}

.state-closed {
  background: #8250df;
  color: white;
}

.label {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  margin-right: 4px;
  margin-bottom: 4px;
}

.assignee {
  display: inline-block;
  margin-right: 4px;
  color: #58a6ff;
}

.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.metric-card {
  background: #161b22;
  padding: 16px;
  border-radius: 6px;
  border: 1px solid #30363d;
}

.metric-card h3 {
  font-size: 12px;
  color: #8b949e;
  text-transform: uppercase;
  margin-bottom: 8px;
  font-weight: 600;
}

.metric-card .value {
  font-size: 32px;
  font-weight: 700;
  color: #58a6ff;
}

.pagination {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 16px;
  padding: 16px;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #8b949e;
}

.error {
  background: #da3633;
  color: white;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 16px;
}

.checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.time-value {
  color: #8b949e;
  font-size: 12px;
}
  </style>
</head>
<body>
  <header>
<div class="container">
  <h1>ðŸš€ OSS Project Management</h1>
</div>
  </header>

  <div class="container">
<div id="auth-section" class="auth-section" style="display: none;">
  <h2>Welcome to OSS Project Management</h2>
  <p>Connect with GitHub to manage your issues and track project metrics</p>
  <a href="/auth" class="btn">Connect with GitHub</a>
</div>

<div id="app-section" style="display: none;">
  <div id="metrics" class="metrics"></div>

  <div class="controls">
    <div class="control-row">
      <div class="control-group">
        <label>Repository:</label>
        <input type="text" id="repository" placeholder="owner/repo" />
      </div>
      <button class="btn btn-secondary btn-small" onclick="syncRepository()">Sync</button>
      <button class="btn btn-small" onclick="loadIssues()">Load Issues</button>
    </div>
    
    <div class="control-row">
      <div class="control-group">
        <label>State:</label>
        <select id="state">
          <option value="all">All</option>
          <option value="open" selected>Open</option>
          <option value="closed">Closed</option>
        </select>
      </div>

      <div class="control-group">
        <label>Label:</label>
        <input type="text" id="label" placeholder="bug, feature, etc." />
      </div>

      <div class="control-group">
        <label>Assignee:</label>
        <input type="text" id="assignee" placeholder="username" />
      </div>
    </div>
  </div>

  <div id="bulk-actions" class="bulk-actions">
    <span id="selected-count">0 selected</span>
    <button class="btn btn-small" onclick="bulkClose()">Close Selected</button>
    <button class="btn btn-small" onclick="bulkReopen()">Reopen Selected</button>
    <button class="btn btn-secondary btn-small" onclick="clearSelection()">Clear</button>
  </div>

  <div id="error" class="error" style="display: none;"></div>
  <div id="loading" class="loading" style="display: none;">Loading...</div>
  
  <table id="issues-table" style="display: none;">
    <thead>
      <tr>
        <th><input type="checkbox" class="checkbox" id="select-all" onchange="toggleSelectAll()" /></th>
        <th class="sortable" onclick="sortBy('number')">#</th>
        <th class="sortable" onclick="sortBy('title')">Title</th>
        <th class="sortable" onclick="sortBy('state')">State</th>
        <th>Labels</th>
        <th>Assignees</th>
        <th class="sortable" onclick="sortBy('created_at')">Created</th>
        <th class="sortable" onclick="sortBy('time_to_close')">Time to Close</th>
      </tr>
    </thead>
    <tbody id="issues-body"></tbody>
  </table>

  <div id="pagination" class="pagination"></div>
</div>
  </div>

  <script>
let currentSort = 'updated_at';
let currentOrder = 'desc';
let currentPage = 1;
let selectedIssues = new Set();

// Check authentication
async function checkAuth() {
  try {
    const response = await fetch('/api/issues?repository=test/test&per_page=1');
    if (response.status === 401) {
      document.getElementById('auth-section').style.display = 'block';
    } else {
      document.getElementById('app-section').style.display = 'block';
    }
  } catch (error) {
    document.getElementById('auth-section').style.display = 'block';
  }
}

// Load issues
async function loadIssues(page = 1) {
  const repository = document.getElementById('repository').value;
  if (!repository) {
    showError('Please enter a repository (owner/repo)');
    return;
  }

  const state = document.getElementById('state').value;
  const label = document.getElementById('label').value;
  const assignee = document.getElementById('assignee').value;

  showLoading(true);
  hideError();

  try {
    const params = new URLSearchParams({
      repository,
      state,
      sort: currentSort,
      order: currentOrder,
      page,
      per_page: 50
    });

    if (label) params.append('label', label);
    if (assignee) params.append('assignee', assignee);

    const response = await fetch('/api/issues?' + params.toString());
    const data = await response.json();

    if (!response.ok) throw new Error(data.error);

    displayIssues(data.issues);
    displayPagination(data.pagination);
    loadMetrics(repository);
    currentPage = page;

  } catch (error) {
    showError(error.message);
  } finally {
    showLoading(false);
  }
}

// Display issues
function displayIssues(issues) {
  const tbody = document.getElementById('issues-body');
  tbody.innerHTML = '';

  if (issues.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #8b949e;">No issues found</td></tr>';
    document.getElementById('issues-table').style.display = 'table';
    return;
  }

  issues.forEach(issue => {
    const row = document.createElement('tr');
    
    const labels = issue.labels.map(l => 
      `<span class="label" style="background-color: #${l.color}; color: ${getContrastColor(l.color)}">${l.name}</span>`
    ).join('');

    const assignees = issue.assignees.map(a => 
      `<span class="assignee">@${a}</span>`
    ).join('');

    const createdDate = new Date(issue.created_at).toLocaleDateString();
    const timeToClose = issue.time_to_close 
      ? formatTimeToClose(issue.time_to_close)
      : '-';

    row.innerHTML = `
      <td><input type="checkbox" class="checkbox issue-checkbox" data-number="${issue.number}" onchange="updateSelection()" /></td>
      <td><a href="${issue.html_url}" target="_blank" class="issue-number">#${issue.number}</a></td>
      <td><span class="issue-title">${escapeHtml(issue.title)}</span></td>
      <td><span class="state-badge state-${issue.state}">${issue.state}</span></td>
      <td>${labels}</td>
      <td>${assignees}</td>
      <td class="time-value">${createdDate}</td>
      <td class="time-value">${timeToClose}</td>
    `;

    tbody.appendChild(row);
  });

  document.getElementById('issues-table').style.display = 'table';
}

// Load metrics
async function loadMetrics(repository) {
  try {
    const response = await fetch('/api/metrics?repository=' + encodeURIComponent(repository));
    const data = await response.json();

    if (!response.ok) return;

    const metricsHtml = `
      <div class="metric-card">
        <h3>Total Issues</h3>
        <div class="value">${data.current.total_issues || 0}</div>
      </div>
      <div class="metric-card">
        <h3>Open Issues</h3>
        <div class="value">${data.current.open_issues || 0}</div>
      </div>
      <div class="metric-card">
        <h3>Closed Issues</h3>
        <div class="value">${data.current.closed_issues || 0}</div>
      </div>
      <div class="metric-card">
        <h3>Avg Time to Close</h3>
        <div class="value">${data.current.avg_time_to_close_days || 0} days</div>
      </div>
    `;

    document.getElementById('metrics').innerHTML = metricsHtml;
  } catch (error) {
    console.error('Error loading metrics:', error);
  }
}

// Sort by column
function sortBy(field) {
  if (currentSort === field) {
    currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort = field;
    currentOrder = 'desc';
  }
  
  updateSortIndicators();
  loadIssues(currentPage);
}

// Update sort indicators
function updateSortIndicators() {
  document.querySelectorAll('th').forEach(th => {
    th.classList.remove('sorted-asc', 'sorted-desc');
  });
  const header = document.querySelector(`th[onclick*="${currentSort}"]`);
  if (header) {
    header.classList.add(currentOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
  }
}

// Pagination
function displayPagination(pagination) {
  const div = document.getElementById('pagination');
  let html = '';

  if (pagination.page > 1) {
    html += `<button class="btn btn-secondary btn-small" onclick="loadIssues(${pagination.page - 1})">Previous</button>`;
  }

  html += `<span style="padding: 0 16px; color: #8b949e;">Page ${pagination.page} of ${pagination.total_pages}</span>`;

  if (pagination.page < pagination.total_pages) {
    html += `<button class="btn btn-secondary btn-small" onclick="loadIssues(${pagination.page + 1})">Next</button>`;
  }

  div.innerHTML = html;
}

// Selection management
function toggleSelectAll() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.issue-checkbox');
  checkboxes.forEach(cb => cb.checked = selectAll.checked);
  updateSelection();
}

function updateSelection() {
  selectedIssues.clear();
  document.querySelectorAll('.issue-checkbox:checked').forEach(cb => {
    selectedIssues.add(parseInt(cb.dataset.number));
  });

  const bulkActions = document.getElementById('bulk-actions');
  const selectedCount = document.getElementById('selected-count');
  
  if (selectedIssues.size > 0) {
    bulkActions.classList.add('active');
    selectedCount.textContent = `${selectedIssues.size} selected`;
  } else {
    bulkActions.classList.remove('active');
  }
}

function clearSelection() {
  selectedIssues.clear();
  document.querySelectorAll('.issue-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all').checked = false;
  updateSelection();
}

// Bulk operations
async function bulkClose() {
  await bulkUpdate({ state: 'closed' });
}

async function bulkReopen() {
  await bulkUpdate({ state: 'open' });
}

async function bulkUpdate(updates) {
  const repository = document.getElementById('repository').value;
  if (selectedIssues.size === 0) return;

  showLoading(true);
  try {
    const response = await fetch('/api/issues/bulk', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        repository,
        issue_numbers: Array.from(selectedIssues),
        updates
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error);

    clearSelection();
    loadIssues(currentPage);
  } catch (error) {
    showError(error.message);
  } finally {
    showLoading(false);
  }
}

// Sync repository
async function syncRepository() {
  const repository = document.getElementById('repository').value;
  if (!repository) {
    showError('Please enter a repository (owner/repo)');
    return;
  }

  showLoading(true);
  try {
    const response = await fetch('/api/sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ repository })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error);

    alert(`Synced ${data.count} issues from ${repository}`);
    loadIssues(currentPage);
  } catch (error) {
    showError(error.message);
  } finally {
    showLoading(false);
  }
}

// Utility functions
function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showError(message) {
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}

function hideError() {
  document.getElementById('error').style.display = 'none';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getContrastColor(hexColor) {
  const r = parseInt(hexColor.substr(0, 2), 16);
  const g = parseInt(hexColor.substr(2, 2), 16);
  const b = parseInt(hexColor.substr(4, 2), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 155 ? '#000' : '#fff';
}

function formatTimeToClose(hours) {
  if (hours < 24) return `${hours}h`;
  const days = Math.floor(hours / 24);
  if (days < 7) return `${days}d`;
  const weeks = Math.floor(days / 7);
  return `${weeks}w`;
}

// Initialize
checkAuth();
  </script>
</body>
</html>
